# LSPサーバー テストスクリプト

このディレクトリには、Groovy LSPサーバーの標準入出力通信をテストするためのスクリプトが含まれています。

## テストスクリプト

### test-stdio.sh
最も基本的なテストスクリプト。LSPサーバーを起動して初期化リクエストを送信します。

```bash
./test-stdio.sh
```

**テスト内容:**
- LSPサーバーの起動確認
- 基本的な標準入出力の動作確認

### test-lsp-server.py
JSON-RPCプロトコルに準拠した完全なメッセージを送信し、レスポンスを解析します。

```bash
python3 test-lsp-server.py
```

**テスト内容:**
- Content-Lengthヘッダーを含む正しいJSON-RPCメッセージの送信
- 初期化、シャットダウン、終了の基本的なライフサイクル
- レスポンスのJSON解析と表示

### test-interactive.py
インタラクティブにLSPサーバーと通信し、各ステップの動作を詳細に検証します。

```bash
python3 test-interactive.py
```

**テスト内容:**
- 個別のメッセージ送受信とレスポンス確認
- 完全なLSPライフサイクルのテスト
- ドキュメント操作の基本テスト（textDocument/didOpen）
- エラーログの確認

## 前提条件

テストを実行する前に、以下のコマンドでLSPサーバーをビルドしてください：

```bash
cd lsp-core
./gradlew installDist
```

## JSON-RPCメッセージフォーマット

LSPサーバーは以下の形式のメッセージを期待します：

```
Content-Length: <バイト数>\r\n
\r\n
{"jsonrpc":"2.0","id":1,"method":"initialize","params":{...}}
```

## 期待される動作

1. **初期化リクエスト**: サーバーは`capabilities`を含むレスポンスを返す
2. **初期化済み通知**: サーバーは通知を受け取る（レスポンスなし）
3. **シャットダウンリクエスト**: サーバーは`null`結果を返す
4. **終了通知**: サーバーはプロセスを終了する

## トラブルシューティング

### サーバーが応答しない場合
- `./gradlew installDist`が実行されているか確認
- Java 23以上がインストールされているか確認
- `build/install/lsp-core/bin/lsp-core`スクリプトが存在するか確認

### JSON-RPCエラーが発生する場合
- Content-Lengthヘッダーが正しく計算されているか確認
- メッセージがUTF-8でエンコードされているか確認
- 改行コードが`\r\n`になっているか確認

## 開発者向け情報

新しいテストスクリプトを追加する場合は、以下の点に注意してください：

1. 標準入出力を適切に処理する（stdout: JSON-RPC、stderr: ログ）
2. タイムアウトを設定してハングを防ぐ
3. プロセスの適切な終了処理を実装する
4. エラーハンドリングを含める